<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Transaksi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/payment.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="curve">
        <h1>Shahaba</h1>
        <h2>Input Pembayaran</h2>
    </div>

    <div class="form-container">
        <h3><i class="fas fa-money-bill-wave"></i> Form Transaksi</h3>
        
        <div class="form-row">
            <div class="form-group half-width">
                <label for="tanggal"><i class="far fa-calendar-alt"></i> Tanggal:</label>
                <input type="date" id="tanggal" required>
            </div>

            <div class="form-group half-width currency-input">
                <label for="nominal"><i class="fas fa-coins"></i> Nominal:</label>
                <input type="text" id="nominal" placeholder="0" inputmode="numeric" required>
            </div>
        </div>

        <div class="form-group half-width">
            <label for="filterJenjang"><i class="fas fa-filter"></i> Filter Jenjang:</label>
            <select id="filterJenjang" onchange="filterStudents()">
                <option value="">Semua Jenjang</option>
                <option value="SD">SD</option>
                <option value="Prasekolah">Prasekolah</option>
            </select>
        </div>

        <div class="form-group autocomplete">
            <label for="nama"><i class="fas fa-user-graduate"></i> Peserta Didik:</label>
            <input type="text" id="nama" placeholder="Cari nama..." autocomplete="off">
            <div class="loading-indicator" id="loadingNames">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div id="autocomplete-list" class="autocomplete-items"></div>
            
            <div id="selectedStudents" class="multi-input-container"></div>
            
            <div id="suggestedStudents" style="margin-top: 10px; display: none;">
                <p style="font-size: 0.8rem; margin-bottom: 5px;">Anak lain dari orang tua yang sama:</p>
                <div id="suggestionsList"></div>
                <input type="hidden" id="hiddenJenjang" name="jenjang">
            </div>
        </div>

            <div class="form-group half-width">
                <label for="metode"><i class="fas fa-wallet"></i> Metode Pembayaran:</label>
                <select id="metode" required>
                    <option value="">Pilih Metode</option>
                    <option value="Tunai">Tunai</option>
                    <option value="Non-Tunai">Non-Tunai</option>
                </select>
            </div>

        <div class="form-group">
            <label><i class="fas fa-tags"></i> Jenis Pembayaran:</label>
            <div class="jenis-container" id="jenisContainer">
                <div class="jenis-input">
                    <input type="text" class="jenis-input-field" placeholder="Contoh: SPP Juli 2024" required>
                    <button type="button" class="remove-row" onclick="removeJenisInput(this)"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <span class="add-row" onclick="addJenisInput()"><i class="fas fa-plus-circle"></i> Tambah Jenis Pembayaran</span>
        </div>
    </div>

        <button class="admin-button" onclick="submitTransaction()">
            <i class="fas fa-save"></i> Simpan Transaksi
        </button>

        <div id="paymentProof" class="payment-proof" style="display: none;">
            <h4><i class="fas fa-receipt"></i> Bukti Transaksi:</h4>
            <div id="proofDetails"></div>
            <button class="admin-button whatsapp-button" onclick="sendWhatsApp()">
                <i class="fab fa-whatsapp"></i> Kirim via WhatsApp
            </button>
        </div>
    </div>

    <script>
// Konfigurasi
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxglh8OWF5LHj80Kfz45w43LdMDXa4TaVZOWSG4Wt4VvHwp2t4fvGOYAhgiWUJBHcsy/exec';
let studentsData = [];
let transactionData = {
    students: [],
    jenisPembayaran: []
};

// Fungsi untuk memformat nominal ke Rupiah
function formatRupiah(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

// Fungsi untuk mengubah format Rupiah ke angka
function parseCurrency(currencyString) {
    return parseInt(currencyString.replace(/[^\d]/g, ''));
}

// Format input nominal
document.getElementById('nominal').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
        value = parseInt(value);
        e.target.value = formatRupiah(value).replace('Rp', '').trim();
    }
});

// Fungsi untuk mengambil data siswa dari Spreadsheet
async function fetchStudents() {
    try {
        document.getElementById('loadingNames').style.display = 'block';
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getStudents'
            })
        });
        
        if (!response.ok) {
            throw new Error('Gagal mengambil data siswa');
        }
        
        const result = await response.json();
        studentsData = result.data || [];
        document.getElementById('loadingNames').style.display = 'none';
    } catch (error) {
        console.error("Gagal mengambil data siswa:", error);
        document.getElementById('loadingNames').style.display = 'none';
        Swal.fire('Error', 'Gagal memuat data siswa', 'error');
    }
}

// Fungsi autocomplete untuk pencarian siswa
function autocompleteName() {
    const input = document.getElementById('nama');
    const autocompleteList = document.getElementById('autocomplete-list');
    
    input.addEventListener('input', function() {
        const inputVal = this.value.trim().toLowerCase();
        autocompleteList.innerHTML = '';
        
        if (!inputVal) return;
        
        const filteredStudents = studentsData.filter(student => 
            student.Nama.toLowerCase().includes(inputVal) || 
            (student['Orang Tua'] && student['Orang Tua'].toLowerCase().includes(inputVal))
        );
        
        if (filteredStudents.length === 0) {
            const item = document.createElement('div');
            item.innerHTML = 'Tidak ditemukan';
            autocompleteList.appendChild(item);
            return;
        }
        
        filteredStudents.forEach(student => {
            const item = document.createElement('div');
            item.innerHTML = `
                <strong>${student.Nama}</strong> (${student.Jenjang})<br>
                <small>${student['Orang Tua']} - ${student.Kelas}</small>
            `;
            item.addEventListener('click', function() {
                addStudentToTransaction({
                    id: student.ID,
                    nama: student.Nama,
                    jenjang: student.Jenjang,
                    parentId: student['Parent ID'],
                    parentName: student['Orang Tua'],
                    parentPhone: student['No. WhatsApp'],
                    parentEmail: student['Email Orang Tua']
                });
                input.value = '';
                autocompleteList.innerHTML = '';
                
                // Tampilkan saudara kandung jika ada
                if (student['Parent ID']) {
                    showSiblings(student['Parent ID']);
                }
            });
            autocompleteList.appendChild(item);
        });
    });
    
    // Sembunyikan autocomplete saat klik di luar
    document.addEventListener('click', function(e) {
        if (e.target.id !== 'nama') {
            autocompleteList.innerHTML = '';
        }
    });
}

// Fungsi untuk menambahkan siswa ke transaksi
function addStudentToTransaction(student) {
    // Cek apakah siswa sudah ada
    const exists = transactionData.students.some(s => s.id === student.id);
    if (exists) {
        Swal.fire('Info', 'Siswa sudah ditambahkan', 'info');
        return;
    }
    
    transactionData.students.push(student);
    renderSelectedStudents();
}

// Fungsi untuk menampilkan siswa yang sudah dipilih
function renderSelectedStudents() {
    const container = document.getElementById('selectedStudents');
    container.innerHTML = '';
    
    transactionData.students.forEach((student, index) => {
        const tag = document.createElement('div');
        tag.className = 'student-tag';
        tag.innerHTML = `
            ${student.nama} (${student.jenjang})
            <button onclick="removeStudent(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(tag);
    });
}

// Fungsi untuk menghapus siswa dari transaksi
function removeStudent(index) {
    transactionData.students.splice(index, 1);
    renderSelectedStudents();
}

// Fungsi untuk menampilkan saudara kandung
function showSiblings(parentId) {
    const siblings = studentsData.filter(student => 
        student['Parent ID'] === parentId && 
        !transactionData.students.some(s => s.id === student.ID)
    );
    
    if (siblings.length > 0) {
        const suggestionsList = document.getElementById('suggestionsList');
        suggestionsList.innerHTML = '';
        
        siblings.forEach(sibling => {
            const div = document.createElement('div');
            div.className = 'sibling-item';
            div.innerHTML = `
                <span>${sibling.Nama} (${sibling.Jenjang})</span>
                <button onclick="addSibling('${sibling.ID}')">
                    <i class="fas fa-plus"></i> Tambah
                </button>
            `;
            suggestionsList.appendChild(div);
        });
        
        document.getElementById('suggestedStudents').style.display = 'block';
    }
}

// Fungsi untuk menambahkan saudara kandung
function addSibling(studentId) {
    const student = studentsData.find(s => s.ID === studentId);
    if (student) {
        addStudentToTransaction({
            id: student.ID,
            nama: student.Nama,
            jenjang: student.Jenjang,
            parentId: student['Parent ID'],
            parentName: student['Orang Tua'],
            parentPhone: student['No. WhatsApp'],
            parentEmail: student['Email Orang Tua']
        });
        document.getElementById('suggestedStudents').style.display = 'none';
    }
}

// Fungsi untuk menambahkan jenis pembayaran
function addJenisInput() {
    const container = document.getElementById('jenisContainer');
    const newInput = document.createElement('div');
    newInput.className = 'jenis-input';
    newInput.innerHTML = `
        <input type="text" class="jenis-input-field" placeholder="Contoh: SPP Juli 2024" required>
        <button type="button" class="remove-row" onclick="removeJenisInput(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newInput);
}

// Fungsi untuk menghapus jenis pembayaran
function removeJenisInput(button) {
    const inputs = document.querySelectorAll('.jenis-input');
    if (inputs.length > 1) {
        button.parentElement.remove();
    } else {
        Swal.fire('Peringatan', 'Minimal harus ada satu jenis pembayaran', 'warning');
    }
}

// Fungsi filter siswa berdasarkan jenjang
function filterStudents() {
    const jenjang = document.getElementById('filterJenjang').value;
    // Reset input nama
    document.getElementById('nama').value = '';
    document.getElementById('autocomplete-list').innerHTML = '';
    
    if (jenjang) {
        fetchStudents(jenjang);
    } else {
        fetchStudents();
    }
}

// Fungsi validasi form
function validateForm() {
    // Validasi siswa
    if (transactionData.students.length === 0) {
        Swal.fire('Peringatan!', 'Pilih minimal 1 peserta didik', 'warning');
        return false;
    }
    
    // Validasi tanggal
    if (!document.getElementById('tanggal').value) {
        Swal.fire('Peringatan!', 'Tanggal harus diisi', 'warning');
        return false;
    }
    
    // Validasi nominal
    const nominal = document.getElementById('nominal').value;
    if (!nominal || parseCurrency(nominal) <= 0) {
        Swal.fire('Peringatan!', 'Nominal harus diisi dengan benar', 'warning');
        return false;
    }
    
    // Validasi metode pembayaran
    if (!document.getElementById('metode').value) {
        Swal.fire('Peringatan!', 'Metode pembayaran harus dipilih', 'warning');
        return false;
    }
    
    // Validasi jenis pembayaran
    const jenisInputs = Array.from(document.querySelectorAll('.jenis-input-field'));
    if (jenisInputs.some(input => !input.value.trim())) {
        Swal.fire('Peringatan!', 'Semua jenis pembayaran harus diisi', 'warning');
        return false;
    }
    
    return true;
}

// Fungsi submit transaksi
async function submitTransaction() {
    if (!validateForm()) return;

    // Kumpulkan jenis pembayaran
    transactionData.jenisPembayaran = Array.from(document.querySelectorAll('.jenis-input-field'))
        .map(input => input.value.trim())
        .filter(value => value);
    
    const transaction = {
        tanggal: document.getElementById('tanggal').value,
        nominal: parseCurrency(document.getElementById('nominal').value),
        students: transactionData.students,
        jenisPembayaran: transactionData.jenisPembayaran,
        metode: document.getElementById('metode').value,
        timestamp: new Date().toISOString()
    };

    try {
        Swal.fire({
            title: 'Menyimpan transaksi...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'saveTransaction',
                data: transaction
            })
        });
        
        if (!response.ok) {
            throw new Error('Gagal menyimpan transaksi');
        }
        
        const result = await response.json();
        
        if (result.success) {
            transaction.id = result.data.transactionId;
            showPaymentProof(transaction);
            
            Swal.fire({
                icon: 'success',
                title: 'Sukses!',
                text: 'Transaksi berhasil dicatat',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'Gagal menyimpan transaksi: ' + error.message,
            confirmButtonText: 'OK'
        });
    }
}

// Fungsi untuk menampilkan bukti pembayaran
function showPaymentProof(transaction) {
    const proofDetails = document.getElementById('proofDetails');
    proofDetails.innerHTML = '';
    
    // Buat daftar siswa
    const studentsList = transaction.students
        .map(s => `<li>${s.nama} (${s.jenjang})</li>`)
        .join('');
    
    // Buat daftar pembayaran
    const paymentList = transaction.jenisPembayaran
        .map((j, i) => `<li>${i+1}. ${j}</li>`)
        .join('');
    
    // Format bukti transaksi
    proofDetails.innerHTML = `
        <div class="proof-section">
            <h5>Detail Transaksi</h5>
            <p><strong>ID Transaksi:</strong> ${transaction.id}</p>
            <p><strong>Tanggal:</strong> ${transaction.tanggal}</p>
            <p><strong>Metode:</strong> ${transaction.metode}</p>
            <p><strong>Total:</strong> ${formatRupiah(transaction.nominal)}</p>
        </div>
        
        <div class="proof-section">
            <h5>Peserta Didik</h5>
            <ul>${studentsList}</ul>
        </div>
        
        <div class="proof-section">
            <h5>Jenis Pembayaran</h5>
            <ul>${paymentList}</ul>
        </div>
    `;
    
    document.getElementById('paymentProof').style.display = 'block';
}

// Fungsi untuk mengirim via WhatsApp
async function sendWhatsApp() {
    try {
        if (transactionData.students.length === 0) {
            Swal.fire('Error', 'Tidak ada siswa yang dipilih', 'error');
            return;
        }
        
        // Gabungkan nama siswa
        const studentsList = transactionData.students
            .map(s => `- ${s.nama} (${s.jenjang})`)
            .join('\n');
        
        // Gabungkan jenis pembayaran
        const paymentList = transactionData.jenisPembayaran
            .map((j, i) => `${i+1}. ${j}`)
            .join('\n');
        
        // Format pesan
        const message = `Yth. Orang Tua/Wali,

Berikut bukti pembayaran untuk:
${studentsList}

Tanggal: ${document.getElementById('tanggal').value}

Detail Pembayaran:
${paymentList}
Total: ${formatRupiah(parseCurrency(document.getElementById('nominal').value))}

Terima kasih.`;

        // Ambil nomor telepon (ambil dari siswa pertama)
        const phone = transactionData.students[0].parentPhone;
        
        if (phone) {
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        } else {
            Swal.fire('Info', 'Nomor WhatsApp orang tua tidak ditemukan', 'info');
        }
    } catch (error) {
        Swal.fire('Error', 'Gagal mengirim WhatsApp', 'error');
    }
}

// Fungsi untuk logout
function logout() {
    sessionStorage.removeItem('adminLoggedIn');
    window.location.href = 'login.html';
}

// Inisialisasi saat halaman dimuat
window.onload = async function() {
    // Cek session
    if (!sessionStorage.getItem('adminLoggedIn')) {
        window.location.href = 'login.html';
        return;
    }
    
    // Set tanggal default ke hari ini
    document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
    
    // Ambil data siswa
    await fetchStudents();
    
    // Setup autocomplete
    autocompleteName();
    
    // Auto refresh data siswa setiap 30 detik
    setInterval(fetchStudents, 30000);
    
    // Submit form dengan Enter
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitTransaction();
        }
    });
};
    </script>
</body>
</html>