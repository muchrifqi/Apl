<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Transaksi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/payment.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="curve">
        <h1>Shahaba</h1>
        <h2>Input Pembayaran</h2>
    </div>

    <div class="form-container">
        <h3><i class="fas fa-money-bill-wave"></i> Form Transaksi</h3>
        
        <div class="form-row">
            <div class="form-group half-width">
                <label for="tanggal"><i class="far fa-calendar-alt"></i> Tanggal:</label>
                <input type="date" id="tanggal" required>
            </div>

            <div class="form-group half-width currency-input">
                <label for="nominal"><i class="fas fa-coins"></i> Nominal:</label>
                <input type="text" id="nominal" placeholder="0" inputmode="numeric" required>
            </div>
        </div>

        <div class="form-group half-width">
            <label for="filterJenjang"><i class="fas fa-filter"></i> Filter Jenjang:</label>
            <select id="filterJenjang" onchange="filterStudents()">
                <option value="">Semua Jenjang</option>
                <option value="SD">SD</option>
                <option value="Prasekolah">Prasekolah</option>
            </select>
        </div>

        <div class="form-group autocomplete">
            <label for="nama"><i class="fas fa-user-graduate"></i> Peserta Didik:</label>
            <input type="text" id="nama" placeholder="Cari nama..." autocomplete="off">
            <div class="loading-indicator" id="loadingNames">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div id="autocomplete-list" class="autocomplete-items"></div>
            
            <div id="selectedStudents" class="multi-input-container"></div>
            
            <div id="suggestedStudents" style="margin-top: 10px; display: none;">
                <p style="font-size: 0.8rem; margin-bottom: 5px;">Anak lain dari orang tua yang sama:</p>
                <div id="suggestionsList"></div>
                <input type="hidden" id="hiddenJenjang" name="jenjang">
            </div>
        </div>

            <div class="form-group half-width">
                <label for="metode"><i class="fas fa-wallet"></i> Metode Pembayaran:</label>
                <select id="metode" required>
                    <option value="">Pilih Metode</option>
                    <option value="Tunai">Tunai</option>
                    <option value="Non-Tunai">Non-Tunai</option>
                </select>
            </div>

        <div class="form-group">
            <label><i class="fas fa-tags"></i> Jenis Pembayaran:</label>
            <div class="jenis-container" id="jenisContainer">
                <div class="jenis-input">
                    <input type="text" class="jenis-input-field" placeholder="Contoh: SPP Juli 2024" required>
                    <button type="button" class="remove-row" onclick="removeJenisInput(this)"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <span class="add-row" onclick="addJenisInput()"><i class="fas fa-plus-circle"></i> Tambah Jenis Pembayaran</span>
        </div>
    </div>

        <button class="admin-button" onclick="submitTransaction()">
            <i class="fas fa-save"></i> Simpan Transaksi
        </button>

        <div id="paymentProof" class="payment-proof" style="display: none;">
            <h4><i class="fas fa-receipt"></i> Bukti Transaksi:</h4>
            <div id="proofDetails"></div>
            <button class="admin-button whatsapp-button" onclick="sendWhatsApp()">
                <i class="fab fa-whatsapp"></i> Kirim via WhatsApp
            </button>
        </div>
    </div>

    <script>
        // Konfigurasi
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznj4FeWebdRPdC4cQ51HAkuPuEAgwxM8elDvY9YWzafRlWmFrkxRrivk73tBUnVBze/exec';

            // Fungsi untuk handle CORS
            async function makeRequest(url, data) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error making request:', error);
                    throw error;
                }
            }

            // Ambil data siswa dari Spreadsheet
            async function fetchStudents() {
                try {
                    document.getElementById('loadingNames').style.display = 'block';
                    const response = await makeRequest(SCRIPT_URL, {
                        action: 'getStudents'
                    });
                    
                    studentsData = response.data || [];
                    document.getElementById('loadingNames').style.display = 'none';
                } catch (error) {
                    console.error("Gagal mengambil data siswa:", error);
                    document.getElementById('loadingNames').style.display = 'none';
                    Swal.fire('Error', 'Gagal memuat data siswa', 'error');
                }
            }

            // Submit Transaksi
            async function submitTransaction() {
                if(!validateForm()) return;

                // Kumpulkan jenis pembayaran
                transactionData.jenisPembayaran = Array.from(document.querySelectorAll('.jenis-input-field'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                const transaction = {
                    tanggal: document.getElementById('tanggal').value,
                    nominal: parseCurrency(document.getElementById('nominal').value),
                    students: transactionData.students,
                    jenisPembayaran: transactionData.jenisPembayaran,
                    metode: document.getElementById('metode').value,
                    timestamp: new Date().toISOString()
                };

                try {
                    Swal.fire({
                        title: 'Menyimpan transaksi...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const result = await makeRequest(SCRIPT_URL, {
                        action: 'saveTransaction',
                        data: transaction
                    });
                    
                    if(result.success) {
                        transaction.id = result.data.transactionId;
                        showPaymentProof(transaction);
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Sukses!',
                            text: 'Transaksi berhasil dicatat',
                            confirmButtonText: 'OK'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Gagal menyimpan transaksi: ' + error.message,
                        confirmButtonText: 'OK'
                    });
                }
            }

        // ... Fungsi uploadPDF, showPaymentProof tetap sama ...

        // Kirim WhatsApp
        async function sendWhatsApp() {
            try {
                if(transactionData.students.length === 0) {
                    Swal.fire('Error', 'Tidak ada siswa yang dipilih', 'error');
                    return;
                }
                
                // Gabungkan nama siswa
                const studentsList = transactionData.students
                    .map(s => `- ${s.nama} (${s.jenjang})`)
                    .join('\n');
                
                // Gabungkan jenis pembayaran
                const paymentList = transactionData.jenisPembayaran
                    .map((j, i) => `${i+1}. ${j}`)
                    .join('\n');
                
                // Format pesan
                const message = `Yth. Orang Tua/Wali,

Berikut bukti pembayaran untuk:
${studentsList}

Tanggal: ${document.getElementById('tanggal').value}

Detail Pembayaran:
${paymentList}
Total: ${formatRupiah(parseCurrency(document.getElementById('nominal').value))}

Terima kasih.`;

                // Ambil nomor telepon (ambil dari siswa pertama)
                const phone = transactionData.students[0].phone;
                
                if(phone) {
                    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
                } else {
                    Swal.fire('Info', 'Nomor WhatsApp orang tua tidak ditemukan', 'info');
                }
            } catch (error) {
                Swal.fire('Error', 'Gagal mengirim WhatsApp', 'error');
            }
        }

        // Validasi Form
        function validateForm() {
            // Validasi siswa
            if(transactionData.students.length === 0) {
                Swal.fire('Peringatan!', 'Pilih minimal 1 peserta didik', 'warning');
                return false;
            }
            
            // Validasi nominal
            if(!document.getElementById('nominal').value.trim()) {
                Swal.fire('Peringatan!', 'Nominal harus diisi', 'warning');
                return false;
            }
            
            // Validasi jenis pembayaran
            const jenisInputs = Array.from(document.querySelectorAll('.jenis-input-field'));
            if(jenisInputs.some(input => !input.value.trim())) {
                Swal.fire('Peringatan!', 'Semua jenis pembayaran harus diisi', 'warning');
                return false;
            }
            
            return true;
        }

        // Inisialisasi
        window.onload = async function() {
            await fetchStudents();
            autocompleteName();
            
            // Set tanggal default ke hari ini
            document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
            
            // Auto refresh data siswa setiap 30 detik
            setInterval(fetchStudents, 30000);
        };
    </script>
</body>
</html>